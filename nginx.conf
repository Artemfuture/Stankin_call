events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    # --- НОВОЕ: Блок для HTTP -> HTTPS редиректа ---
    server {
        listen 80;
        server_name stankincalls.ru www.stankincalls.ru;
        # Certbot использует этот сервер для HTTP-валидации при первом получении/обновлении
        location /.well-known/acme-challenge/ {
             root /var/www/certbot; # Убедитесь, что Certbot может записать сюда файлы (необязательно для монтирования, если используете standalone или webroot в другом месте)
        }
        # Редирект на HTTPS
        return 301 https://$server_name$request_uri;
    }
    # --- КОНЕЦ НОВОГО ---

    # --- НОВОЕ: Блок для HTTPS ---
    server {
        listen 443 ssl;
        server_name stankincalls.ru www.stankincalls.ru;

        # Пути к SSL-сертификатам (теперь доступны из контейнера)
        ssl_certificate /etc/letsencrypt/live/stankincalls.ru/fullchain.pem; # ЗАМЕНИТЕ НА СВОЙ ДОМЕН
        ssl_certificate_key /etc/letsencrypt/live/stankincalls.ru/privkey.pem; # ЗАМЕНИТЕ НА СВОЙ ДОМЕН

        # Основные настройки SSL (можно добавить из рекомендаций Mozilla)
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA384;
        ssl_prefer_server_ciphers off;

        # Блок для проксирования запросов к Flask-приложению
        location / {
            proxy_pass http://web:5000; # Имя сервиса 'web' из docker-compose.yml
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme; # ВАЖНО для Flask-SocketIO
        }

        # Блок для проксирования WebSocket/Engine.IO (Flask-SocketIO)
        location /socket.io/ {
            proxy_pass http://web:5000/socket.io/; # Имя сервиса 'web' из docker-compose.yml
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme; # ВАЖНО для WebSocket через HTTPS
        }

        # (Опционально) Блок для статических файлов, если Flask не отдает их
        # location /static/ {
        #     alias /app/static/; # Путь внутри контейнера Flask
        # }
    }
    # --- КОНЕЦ НОВОГО ---
}